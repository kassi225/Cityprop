{% load static %}
{% load humanize %} 

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{{ facture.type_document }} N°{{ facture.numero_document }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background-color: #f4f7f6; }
        .invoice-box { 
            max-width: 900px; margin: auto; border: 1px solid #eee; 
            background-color: white; box-shadow: 0 0 15px rgba(0,0,0,0.1); padding: 35px; 
        }
        .logo { width: 75px; height: auto; margin-right: 15px; }
        .table-box { width: 100%; border-collapse: collapse; margin-top: 25px; }
        .table-box th, .table-box td { border: 1px solid #333; padding: 10px; }
        .table-box th { background-color: #f8f9fa; text-transform: uppercase; font-size: 0.9em; }
        .client-info-box { border: 1.5px solid #333; padding: 15px; width: 320px; float: right; }
        
        @media print {
            .no-print { display: none !important; }
            .invoice-box { box-shadow: none; border: none; padding: 0; }
        }
    </style>
</head>
<body>

<div class="invoice-box">
    <div class="text-right mb-4 no-print d-flex justify-content-end align-items-center">
        
        {% if facture.type_document == "FACTURE" %}
        <a href="{% url 'dashboard_financier' %}" class="btn btn-sm btn-info shadow-sm mr-auto">
            <i class="fas fa-chart-line"></i> Dashboard Financier
        </a>
        {% else %}
        <div class="mr-auto"></div>
        {% endif %}

        <a href="{% url 'detail_fiche' fiche_id=facture.commande.id %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour Fiche
        </a>
        
        <a href="{% url 'telecharger_devis_pdf' facture.id %}" class="btn btn-sm btn-primary shadow-sm ml-2">
            <i class="fas fa-file-download"></i> Télécharger PDF
        </a>
    </div>

    <div class="clearfix mb-4">
        <div class="float-left d-flex align-items-center">
            <img src="{% static 'images/cityprop_logo.png' %}" class="logo" alt="Logo CityProp">
            <div>
                <h3 class="mb-0 font-weight-bold" style="color: #1e3a8a;">CITY PROP</h3>
                <small class="text-muted text-uppercase">Nettoyage industriel & assainissement</small>
            </div>
        </div>
        <div class="float-right text-right">
            <h2 class="font-weight-bold text-primary">{{ facture.type_document|upper }}</h2>
            <p class="mb-0">N° {{ facture.numero_document }}</p>
            <p>Émise le {{ facture.date_emission|date:"d/m/Y" }}</p>
        </div>
    </div>

    <div class="clearfix" style="margin-top: 40px;">
        <div class="float-left" style="width: 50%;">
            <p class="mb-1"><strong>Objet :</strong></p>
            <p>{{ facture.objet|default:"Prestations professionnelles" }}</p>
        </div>
        <div class="client-info-box">
            <p><strong>CLIENT :</strong> {{ facture.commande.nom_client|upper }}</p>
            <p><strong>LIEU :</strong> {{ facture.commande.localisation_client|default:"-" }}</p>
            <p class="mb-0"><strong>TÉL :</strong> {{ facture.commande.numero_client|default:"-" }}</p>
        </div>
    </div>

    <table class="table-box">
        <thead>
            <tr class="text-center">
                <th>Désignation</th>
                <th style="width: 10%;">Qté</th>
                <th style="width: 20%;">P.U (FCFA)</th>
                <th style="width: 20%;">Total (FCFA)</th>
            </tr>
        </thead>
        <tbody>
            {% for ligne in facture.lignes.all %}
            <tr>
                <td>
                    <div class="font-weight-bold">{{ ligne.designation }}</div>
                    {% if ligne.note_prix_unitaire %}
                        <small class="text-muted" style="font-style: italic;">Note : {{ ligne.note_prix_unitaire }}</small>
                    {% endif %}
                </td>
                <td class="text-center">{{ ligne.quantite }}</td>
                <td class="text-right">{{ ligne.prix_unitaire|intcomma }}</td>
                <td class="text-right font-weight-bold">{{ ligne.prix_total|intcomma }}</td>
            </tr>
            {% endfor %}
            
            <tr>
                <td colspan="3" class="text-right font-weight-bold">TOTAL HT</td>
                <td class="text-right font-weight-bold">{{ facture.total_ht_lignes|intcomma }}</td>
            </tr>

            {% if facture.montant_reduction > 0 %}
            <tr class="text-danger">
                <td colspan="3" class="text-right font-weight-bold">
                    REMISE ({{ facture.taux_reduction_pourcentage|floatformat:2 }}%)
                </td>
                <td class="text-right font-weight-bold">- {{ facture.montant_reduction|intcomma }}</td>
            </tr>
            {% endif %}

            <tr style="background-color: #f1f5f9; font-size: 1.1em;">
                <td colspan="3" class="text-right font-weight-bold">NET À PAYER (CFA)</td>
                <td class="text-right font-weight-bold text-primary">{{ facture.montant_final_net|intcomma }} FCFA</td>
            </tr>
        </tbody>
    </table>

    <div class="mt-4">
        <p class="mb-1">Arrêtée la présente facture à la somme de :</p>
        <p class="font-weight-bold text-uppercase p-2 bg-light border-left border-dark">
            {{ facture.total_lettres }}
        </p>
    </div>

    <div class="text-right mt-5">
        <p>{{ facture.lieu_emission|default:"Abidjan" }}, le {{ facture.date_emission|date:"d/m/Y" }}</p>
        <br><br>
        <p class="font-weight-bold text-uppercase" style="text-decoration: underline;">{{ facture.signature|upper }}</p>
    </div>

    <div class="footer-note mt-5 pt-3 border-top text-center text-muted small">
        CITY PROP SARL – Capital 1 000 000 FCFA – Cocody Abatta Cité BNETD, Abidjan<br>
        Tél : (+225) 07 47 35 54 00 / 07 78 17 60 97 – citypropre@gmail.com<br>
        RCCM CI-ABJ-03-2022-B13-11314
    </div>
</div>

</body>
</html>