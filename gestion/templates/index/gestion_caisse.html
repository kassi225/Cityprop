{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<style>
    :root { 
        --in-color: #059669; 
        --out-color: #dc2626; 
        --bg-app: #f8fafc; 
        --primary: #2563eb;
    }
    
    body { background-color: var(--bg-app); font-family: 'Segoe UI', Roboto, sans-serif; font-size: 0.85rem; }

    /* Boutons Colorés & Animés */
    .btn-compact {
        height: 34px; padding: 0 15px; border-radius: 8px; font-size: 0.75rem;
        font-weight: 800; display: inline-flex; align-items: center; gap: 6px; 
        border: none; transition: all 0.2s ease; cursor: pointer; color: white;
    }
    .btn-compact:active { transform: scale(0.95); }
    
    .btn-entree { background-color: var(--in-color); box-shadow: 0 4px 0 #047857; }
    .btn-entree:hover { background-color: #047857; }
    
    .btn-sortie { background-color: var(--out-color); box-shadow: 0 4px 0 #b91c1c; }
    .btn-sortie:hover { background-color: #b91c1c; }
    
    .btn-save { background-color: var(--primary); box-shadow: 0 4px 0 #1d4ed8; }
    .btn-save:hover { background-color: #1d4ed8; }

    .btn-excel { background-color: #166534; box-shadow: 0 4px 0 #14532d; }

    /* Stats Cards */
    .stat-box {
        background: white; border-radius: 10px; padding: 10px;
        border: 1px solid #e2e8f0; border-left: 5px solid var(--primary);
    }
    .stat-label { font-size: 0.65rem; color: #64748b; text-transform: uppercase; font-weight: 700; }
    .stat-value { font-size: 1.2rem; font-weight: 900; }

    /* Tableau & Inputs */
    .table-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .table thead th { background: #f1f5f9; color: #1e293b; font-weight: 700; text-transform: uppercase; font-size: 0.7rem; border: none; }
    
    .row-in { background-color: rgba(16, 185, 129, 0.05) !important; border-left: 4px solid var(--in-color) !important; }
    .row-out { background-color: rgba(239, 68, 68, 0.05) !important; border-left: 4px solid var(--out-color) !important; }

    .input-flat {
        border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px 8px;
        width: 100%; background: white; font-size: 0.8rem;
    }
    .input-flat:focus { border-color: var(--primary); outline: 2px solid rgba(37, 99, 235, 0.1); }

    /* Scroller pour mois */
    .month-nav { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; }
    .month-btn { 
        padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700;
        text-decoration: none; background: white; color: #64748b; border: 1px solid #e2e8f0;
    }
    .month-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
</style>

<div class="container-fluid py-2">
    <div class="row align-items-center mb-3">
        <div class="col-md-4">
            <h4 class="fw-black mb-0" style="color: #0f172a;"><i class="fas fa-coins text-warning me-2"></i>CAISSE {{ annee_actuelle }}</h4>
            <div class="month-nav mt-2">
                {% for id, nom in liste_mois.items %}
                <a href="?mois={{ id }}&annee={{ annee_actuelle }}" class="month-btn {% if id == mois_actuel_id %}active{% endif %}">
                    {{ nom|slice:":3"|upper }}
                </a>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-8">
            <div class="row g-2">
                <div class="col-6">
                    <div class="stat-box">
                        <span class="stat-label">Solde du Mois {{ mois_actuel_nom }}</span>
                        <div id="header-solde-mois" class="stat-value text-success">0 FCFA</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-box" style="border-left-color: #f59e0b;">
                        <span class="stat-label">Cumul Annuel</span>
                        <div class="stat-value text-warning">{{ solde_annuel|floatformat:0|intcomma }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white p-2 rounded shadow-sm border mb-3">
        <div class="row g-2">
            <div class="col-md-2"><input type="date" id="f-date" class="input-flat" onchange="filterTable()"></div>
            <div class="col-md-2"><input type="text" id="f-equipe" class="input-flat" placeholder="Filtrer Équipe..." onkeyup="filterTable()"></div>
            <div class="col-md-4"><input type="text" id="f-libelle" class="input-flat" placeholder="Rechercher une opération..." onkeyup="filterTable()"></div>
            <div class="col-md-2">
                <select id="f-type" class="input-flat" onchange="filterTable()">
                    <option value="">Tous les types</option>
                    <option value="ENTREE">ENTRÉES</option>
                    <option value="SORTIE">SORTIES</option>
                </select>
            </div>
            <div class="col-md-2">
                <button onclick="clearFilters()" class="btn btn-outline-secondary btn-sm w-100 fw-bold">
                    <i class="fas fa-sync-alt"></i> RESET
                </button>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mb-3 bg-white p-2 rounded border shadow-sm">
        <div class="d-flex gap-2">
            <button type="button" onclick="addNewRow('ENTREE')" class="btn-compact btn-entree">
                <i class="fas fa-arrow-up"></i> + ENTRÉE
            </button>
            <button type="button" onclick="addNewRow('SORTIE')" class="btn-compact btn-sortie">
                <i class="fas fa-arrow-down"></i> - SORTIE
            </button>
        </div>
        <div class="d-flex gap-2">
            <button type="submit" form="caisse-form" class="btn-compact btn-save">
                <i class="fas fa-check-double"></i> SAUVEGARDER
            </button>
            <a href="{% url 'export_excel' mois_actuel_id annee_actuelle %}" class="btn-compact btn-excel text-decoration-none">
                <i class="fas fa-file-excel"></i> EXCEL
            </a>
        </div>
    </div>

    <form method="post" id="caisse-form">
        {% csrf_token %} {{ formset.management_form }}
        <div class="table-card">
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0" id="caisse-table" style="min-width: 900px;">
                    <thead>
                        <tr>
                            <th class="text-center" width="40">#</th>
                            <th width="130">Date</th>
                            <th width="140">Équipe</th>
                            <th>Libellé / Désignation</th>
                            <th width="120">Mouvement</th>
                            <th width="140" class="text-end">Montant</th>
                            <th width="140" class="text-end">Solde Ligne</th>
                            <th width="50"></th>
                        </tr>
                    </thead>
                    <tbody id="formset-container">
                        {% for form in formset %}
                        <tr class="caisse-row">
                            <td class="text-center fw-bold text-muted">{{ forloop.counter }}</td>
                            <td><input type="date" name="{{ form.date.html_name }}" class="input-flat row-date" value="{{ form.date.value|date:'Y-m-d' }}" required></td>
                            <td><input type="text" name="{{ form.equipe.html_name }}" class="input-flat" value="{{ form.equipe.value|default:'' }}"></td>
                            <td><input type="text" name="{{ form.libelle.html_name }}" class="input-flat fw-bold row-libelle" value="{{ form.libelle.value|default:'' }}"></td>
                            <td>
                                <select name="{{ form.type_mouvement.html_name }}" class="input-flat fw-bold row-type">
                                    <option value="ENTREE" {% if form.type_mouvement.value == "ENTREE" %}selected{% endif %}>ENTRÉE</option>
                                    <option value="SORTIE" {% if form.type_mouvement.value == "SORTIE" %}selected{% endif %}>SORTIE</option>
                                </select>
                            </td>
                            <td><input type="number" step="0.01" name="{{ form.montant.html_name }}" class="input-flat text-end fw-bold row-montant" value="{{ form.montant.value|stringformat:'.2f' }}"></td>
                            <td class="text-end fw-bold"><span class="cumul-text">0</span></td>
                            <td class="text-center">
                                <div class="d-none">{{ form.DELETE }}</div>
                                <button type="button" class="btn btn-sm btn-link text-danger btn-delete-row"><i class="fas fa-trash"></i></button>
                            </td>
                            <td class="d-none">{{ form.id }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </form>
</div>

<table class="d-none">
    <tr id="empty-row-model" class="caisse-row">
        <td class="text-center text-primary"><i class="fas fa-plus-circle"></i></td>
        <td><input type="date" name="form-__prefix__-date" class="input-flat row-date" required></td>
        <td><input type="text" name="form-__prefix__-equipe" class="input-flat"></td>
        <td><input type="text" name="form-__prefix__-libelle" class="input-flat fw-bold row-libelle"></td>
        <td>
            <select name="form-__prefix__-type_mouvement" class="input-flat fw-bold row-type">
                <option value="ENTREE">ENTRÉE</option>
                <option value="SORTIE">SORTIE</option>
            </select>
        </td>
        <td><input type="number" step="0.01" name="form-__prefix__-montant" class="input-flat text-end fw-bold row-montant" value="0.00"></td>
        <td class="text-end fw-bold"><span class="cumul-text">0</span></td>
        <td class="text-center"><button type="button" class="btn btn-sm btn-link text-danger btn-delete-row"><i class="fas fa-trash"></i></button></td>
    </tr>
</table>

<script>
    const MOIS = {{ mois_actuel_id }};
    const ANNEE = {{ annee_actuelle }};
    const minD = `${ANNEE}-${MOIS.toString().padStart(2, '0')}-01`;
    const maxD = new Date(ANNEE, MOIS, 0).toISOString().split('T')[0];

    const money = new Intl.NumberFormat('fr-FR');

    function refreshTotals() {
        let runningBal = 0;
        document.querySelectorAll('#formset-container .caisse-row').forEach(row => {
            if (row.style.display === 'none' || row.querySelector('input[name$="-DELETE"]').checked) return;
            
            const m = parseFloat(row.querySelector('.row-montant').value) || 0;
            const t = row.querySelector('.row-type').value;
            const mField = row.querySelector('.row-montant');

            if (t === 'ENTREE') {
                runningBal += m;
                row.className = 'caisse-row row-in';
                mField.style.color = 'var(--in-color)';
            } else {
                runningBal -= m;
                row.className = 'caisse-row row-out';
                mField.style.color = 'var(--out-color)';
            }
            row.querySelector('.cumul-text').innerText = money.format(runningBal);
        });
        
        const h = document.getElementById('header-solde-mois');
        h.innerText = money.format(runningBal) + " FCFA";
        h.className = runningBal >= 0 ? 'stat-value text-success' : 'stat-value text-danger';
    }

    function addNewRow(type) {
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const count = parseInt(totalForms.value);
        const model = document.getElementById('empty-row-model').cloneNode(true);
        
        model.id = "";
        model.innerHTML = model.innerHTML.replace(/__prefix__/g, count);
        
        const dateInp = model.querySelector('.row-date');
        const today = new Date().toISOString().split('T')[0];
        dateInp.value = (today >= minD && today <= maxD) ? today : minD;
        
        model.querySelector('.row-type').value = type;
        document.getElementById('formset-container').appendChild(model);
        
        totalForms.value = count + 1;
        refreshTotals();
        model.querySelector('.row-libelle').focus();
    }

    function clearFilters() {
        document.getElementById('f-date').value = "";
        document.getElementById('f-equipe').value = "";
        document.getElementById('f-libelle').value = "";
        document.getElementById('f-type').value = "";
        filterTable();
    }

    function filterTable() {
        const d = document.getElementById('f-date').value;
        const e = document.getElementById('f-equipe').value.toLowerCase();
        const l = document.getElementById('f-libelle').value.toLowerCase();
        const t = document.getElementById('f-type').value;

        document.querySelectorAll('#formset-container .caisse-row').forEach(row => {
            const rowD = row.querySelector('.row-date').value;
            const rowE = row.querySelector('input[name*="equipe"]').value.toLowerCase();
            const rowL = row.querySelector('.row-libelle').value.toLowerCase();
            const rowT = row.querySelector('.row-type').value;

            const show = (!d || rowD === d) && (!e || rowE.includes(e)) && (!l || rowL.includes(l)) && (!t || rowT === t);
            row.style.display = show ? "" : "none";
        });
        refreshTotals();
    }

    // Event listeners pour la réactivité immédiate
    document.addEventListener('input', e => {
        if (e.target.classList.contains('row-montant') || e.target.classList.contains('row-type')) {
            refreshTotals();
        }
    });

    document.addEventListener('click', e => {
        const btn = e.target.closest('.btn-delete-row');
        if (btn) {
            const row = btn.closest('.caisse-row');
            const idField = row.querySelector('input[name*="-id"]');
            if (idField && idField.value) {
                row.style.display = 'none';
                row.querySelector('input[name$="-DELETE"]').checked = true;
            } else {
                row.remove();
            }
            refreshTotals();
        }
    });

    window.onload = refreshTotals;
</script>
{% endblock %}