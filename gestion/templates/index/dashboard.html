{% extends "base.html" %}
{% block title %}Cockpit | Analyse Comparative{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<style>
    :root {
        --city-green: #1D9A6C;
        --last-week: #cbd5e1;
        --ko-red: #ef4444;
        --royal-blue: #0f172a;
    }
    body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
    .kpi-card {
        background: white; border: none; border-radius: 20px;
        padding: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: all 0.3s ease; height: 100%;
    }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.08); }
    .alert-city-danger { background: #fff5f5; border: 1px solid #fee2e2; position: relative; }
    .badge-ko-pulse {
        background: var(--ko-red); color: white; font-size: 11px; font-weight: 800; 
        padding: 5px 12px; border-radius: 50px; position: absolute; top: 15px; right: 15px;
        animation: pulseCustom 2s infinite;
    }
    @keyframes pulseCustom {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }
    .search-container {
        background: white; border-radius: 50px; padding: 8px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
        width: 100%; max-width: 500px;
    }
    .chart-container { position: relative; height: 350px; width: 100%; }
</style>

<div class="container-fluid py-4 px-3 px-lg-5">
    <div class="row align-items-center mb-4 g-3">
        <div class="col-12 col-xl-4">
            <h1 class="fw-900 text-dark mb-0 animate__animated animate__fadeInDown">Cockpit de Pilotage</h1>
            <p class="text-muted small">Analyse comparative des flux de commandes.</p>
        </div>
        <div class="col-12 col-md-6 col-xl-4">
            <form action="{% url 'liste_fiches' %}" method="GET" class="search-container d-flex align-items-center mx-auto mx-xl-0">
                <i class="fa-solid fa-search text-muted me-3"></i>
                <input type="text" name="q" class="border-0 bg-transparent w-100" placeholder="Rechercher (CTRL+K)" style="outline:none;">
            </form>
        </div>
        <div class="col-12 col-md-6 col-xl-4 text-md-end">
            <form method="GET" class="d-inline-flex gap-2 align-items-center bg-white p-2 rounded-pill shadow-sm">
                <input type="date" name="start_date" class="form-control form-control-sm border-0" value="{{ start_date }}">
                <span class="text-muted small">au</span>
                <input type="date" name="end_date" class="form-control form-control-sm border-0" value="{{ end_date }}">
                <button type="submit" class="btn btn-dark btn-sm rounded-pill px-3">Filtrer</button>
            </form>
        </div>
    </div>

    <div class="row g-4 mb-5 animate__animated animate__fadeInUp">
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="kpi-card {% if total_ko_ret > 0 %}alert-city-danger{% endif %}">
                {% if total_ko_ret > 0 %}
                <span class="badge-ko-pulse">{{ total_ko_ret }} KO RETOUR</span>
                {% endif %}
                <div class="text-muted small fw-bold mb-1">CITYPROP</div>
                <div class="h2 fw-900 mb-0 {% if total_ko_ret > 0 %}text-danger{% endif %}">{{ total_cityprop }}</div>
                <div class="mt-2 small text-muted">Qualité de service</div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="kpi-card">
                <div class="text-muted small fw-bold mb-1">CLIMATISEURS</div>
                <div class="h2 fw-900 mb-0 text-primary">{{ total_clim }}</div>
                <div class="progress mt-3" style="height: 6px; border-radius: 10px;">
                    <div class="progress-bar bg-primary" style="width: 70%"></div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="kpi-card">
                <div class="text-muted small fw-bold mb-1">TAPISPROP</div>
                <div class="h2 fw-900 mb-0 text-warning">{{ total_tapis }}</div>
                <div class="small text-danger mt-2 fw-bold"><i class="fa-solid fa-clock"></i> {{ alertes_tapis_7j }} Retards Atelier</div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="kpi-card bg-dark text-white">
                <div class="text-white-50 small fw-bold mb-1">VOLUME TOTAL</div>
                <div class="h2 fw-900 mb-0">{{ total_commandes }}</div>
                <div class="mt-2 small text-warning fw-bold">
                    <i class="fa-solid fa-bullseye"></i> {{ total_a_fideliser }} à fidéliser
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="kpi-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0">Performance Hebdomadaire (Commandes)</h5>
                    <div class="d-flex gap-3">
                        <small><span class="badge me-1" style="background:var(--city-green);width:10px;height:10px;"></span> Actuelle</small>
                        <small><span class="badge me-1" style="background:var(--last-week);width:10px;height:10px;"></span> Précédente</small>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="doubleChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-8">
            <div class="kpi-card p-0 overflow-hidden">
                <div class="p-4 border-bottom d-flex justify-content-between">
                    <h6 class="fw-bold mb-0">Dernières Activités</h6>
                    <a href="{% url 'liste_fiches' %}" class="btn btn-sm btn-link text-dark p-0">Voir tout</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Client</th>
                                <th>Service</th>
                                <th>Date</th>
                                <th class="text-end pe-4">Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in commandes_recents %}
                            <tr>
                                <td class="ps-4"><strong>{{ c.nom_client }}</strong></td>
                                <td>{{ c.get_type_commande_display }}</td>
                                <td class="text-muted small">{{ c.date_creation|date:"d M, H:i" }}</td>
                                <td class="text-end pe-4">
                                    <span class="badge {% if c.type_commande == 'TAPISPROP' %}bg-warning text-dark{% else %}bg-success{% endif %}">Enregistré</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="kpi-card">
                <h6 class="fw-bold mb-4">Top Clients (Période)</h6>
                {% for client in top_clients %}
                <div class="d-flex justify-content-between mb-3 p-2 rounded bg-light">
                    <span class="small fw-bold">{{ client.nom_client }}</span>
                    <span class="badge bg-white text-dark border">{{ client.total }} cmd</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('doubleChart').getContext('2d');
    const labels = {{ labels_jours|safe }};
    const dataA = {{ stats_actuelle|safe }};
    const dataP = {{ stats_precedente|safe }};

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Cette semaine',
                    data: dataA,
                    borderColor: '#1D9A6C',
                    backgroundColor: 'rgba(29, 154, 108, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5
                },
                {
                    label: 'Semaine dernière',
                    data: dataP,
                    borderColor: '#cbd5e1',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}