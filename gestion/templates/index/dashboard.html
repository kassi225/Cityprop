{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}


<style>
    .kpi-card {
        border-radius: 12px;
        transition: transform .2s, box-shadow .2s;
        cursor: pointer;
    }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,.12); }
    .kpi-icon { font-size: 1.8rem; }
    .kpi-value { font-size: 1.9rem; font-weight: 700; }
    .section-title { font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 15px; }
    .badge-status { font-size: .8rem; padding: 5px 10px; border-radius: 25px; }
    .table-hover tbody tr:hover { background-color: #f1f8f4; }
</style>

<div class="container mt-4">

    <h2 class="mb-4"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>

    <!-- ================= KPIs ================= -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card kpi-card text-center p-3 bg-light" onclick="window.location.href='{% url 'liste_fiches' %}'">
                <div class="kpi-icon text-primary"><i class="fa-solid fa-boxes-stacked"></i></div>
                <div class="kpi-value text-primary">{{ total_commandes }}</div>
                <small>Total commandes</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card kpi-card text-center p-3 bg-light" onclick="window.location.href='{% url 'liste_fiches' %}?type_commande=CITYPROP'">
                <div class="kpi-icon text-success"><i class="fa-solid fa-building"></i></div>
                <div class="kpi-value text-success">{{ total_cityprop }}</div>
                <small>CityProp</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card kpi-card text-center p-3 bg-light" onclick="window.location.href='{% url 'liste_fiches' %}?type_commande=CLIMATISEUR'">
                <div class="kpi-icon text-info"><i class="fa-solid fa-snowflake"></i></div>
                <div class="kpi-value text-info">{{ total_clim }}</div>
                <small>Climatiseur</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card kpi-card text-center p-3 bg-light" onclick="window.location.href='{% url 'liste_fiches' %}?type_commande=TAPISPROP'">
                <div class="kpi-icon text-warning"><i class="fa-solid fa-rug"></i></div>
                <div class="kpi-value text-warning">{{ total_tapis }}</div>
                <small>TapisProp</small>
            </div>
        </div>
    </div>

    <!-- ================= FIDELISATION ================= -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm p-3 h-100">
                <div class="section-title"><i class="fa-solid fa-handshake"></i> Fidélisation</div>
                <p><i class="fa-solid fa-check-circle text-success"></i> Clients fidélisés : <strong>{{ fidelises }}</strong></p>
                <p><i class="fa-solid fa-circle-xmark text-danger"></i> À fidéliser : <strong>{{ non_fidelises }}</strong></p>
                <p><i class="fa-solid fa-calendar-days text-info"></i> Ce mois-ci : <strong>{{ fidelisations_mois }}</strong></p>
                <a href="{% url 'alertes_fidelisation' %}" class="btn btn-success btn-sm mt-2"><i class="fa-solid fa-bell"></i> Voir les rappels</a>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3 h-100">
                <div class="section-title"><i class="fa-solid fa-triangle-exclamation"></i> Alertes fidélisation</div>
                <p><i class="fa-solid fa-building text-danger"></i> CityProp : <strong>{{ alertes_city }}</strong></p>
                <p><i class="fa-solid fa-snowflake text-danger"></i> Climatiseur : <strong>{{ alertes_clima }}</strong></p>
                <p><i class="fa-solid fa-rug text-danger"></i> TapisProp : <strong>{{ alertes_tapis }}</strong></p>
            </div>
        </div>
    </div>

    <!-- ================= TAPIS ALERTES ================= -->
    <div class="card shadow-sm p-3 mb-4">
        <div class="section-title"><i class="fa-solid fa-clock"></i> Alertes Tapis</div>
        <p><i class="fa-solid fa-triangle-exclamation text-danger"></i> En retard (+7 jours) : <strong>{{ alertes_tapis_7j }}</strong></p>
        <p><i class="fa-solid fa-check text-info"></i> Traité ce mois : <strong>{{ tapis_traite_mois }}</strong></p>
        <a href="{% url 'alertes_tapis_retard' %}" class="btn btn-warning btn-sm"><i class="fa-solid fa-rug"></i> Gérer les alertes tapis</a>
    </div>

    <!-- ================= STATUT TAPIS ================= -->
    <div class="card shadow-sm p-3 mb-4">
        <div class="section-title"><i class="fa-solid fa-box"></i> Statuts TapisProp</div>
        <div class="row text-center g-2">
            <div class="col-md">
                <span class="badge bg-danger badge-status">Non respecté</span>
                <h5>{{ tapis_non_respecte }}</h5>
            </div>
            <div class="col-md">
                <span class="badge bg-warning text-dark badge-status">En attente</span>
                <h5>{{ tapis_pret }}</h5>
            </div>
            <div class="col-md">
                <span class="badge bg-info text-dark badge-status">Tapis PRET Client indispo</span>
                <h5>{{ tapis_client_indispo }}</h5>
            </div>
            <div class="col-md">
                <span class="badge bg-success badge-status">Livré satisfait</span>
                <h5>{{ tapis_livre_satisfait }}</h5>
            </div>
            <div class="col-md">
                <span class="badge bg-dark badge-status">Livré insatisfait</span>
                <h5>{{ tapis_livre_insatisfait }}</h5>
            </div>
        </div>
    </div>

    <!-- ================= COMMANDES ================= -->
    <div class="card shadow-sm p-3 mb-4">
        <div class="section-title"><i class="fa-solid fa-clock-rotate-left"></i> Dernières commandes</div>
        <table class="table table-hover table-sm">
            <thead class="table-success">
                <tr>
                    <th>Client</th>
                    <th>Numéro</th>
                    <th>Type</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for c in commandes_recents %}
                <tr>
                    <td>{{ c.nom_client }}</td>
                    <td>{{ c.numero_client }}</td>
                    <td>{{ c.type_commande }}</td>
                    <td>{{ c.date_creation|date:"d/m/Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4">Aucune commande</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ================= TOP CLIENTS ================= -->
    <div class="card shadow-sm p-3 mb-4">
        <div class="section-title"><i class="fa-solid fa-crown"></i> Top clients</div>
        <ul class="list-group list-group-flush">
            {% for client in top_clients %}
            <li class="list-group-item d-flex justify-content-between align-items-center"
                onclick="window.location.href='{% url 'liste_fiches' %}?nom_client={{ client.nom_client }}'"
                style="cursor:pointer">
                {{ client.nom_client }}
                <span class="badge bg-success">{{ client.total }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>

</div>
{% endblock %}
