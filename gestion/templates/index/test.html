{% extends "base.html" %}
{% block title %}Fiche Client - {{ commande.nom_client }}{% endblock %}

{% block content %}

<style>
/* Styles existants pour l'ergonomie */
body { font-size: 0.9rem; }
.card { border-radius: 0.5rem; transition: transform 0.25s, box-shadow 0.25s; }
.card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
.form-label { font-weight: 600; }
input, select, textarea { font-size: 0.85rem; padding: 0.3rem 0.5rem; }
textarea { min-height: 60px; resize: vertical; }
.btn i { margin-right: 5px; }
.ligne-facture { margin-bottom: 5px; }
</style>

<div class="container mt-3">

    <h4 class="mb-4"><i class="fa-solid fa-file-alt me-2"></i>Détail Commande: **{{ commande.nom_client }}**</h4>

    <div class="row g-3">

        <div class="col-lg-6 col-md-12">

            <div class="card mb-3 border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <i class="fa-solid fa-info-circle me-1"></i>Infos générales
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#infosGen">
                        <i class="fa-solid fa-chevron-down"></i>
                    </button>
                </div>
                <div class="card-body collapse show" id="infosGen">
                    <div class="row g-2">
                        <div class="col-6"><strong>Nom:</strong> {{ commande.nom_client }}</div>
                        <div class="col-6"><strong>Numéro:</strong> {{ commande.numero_client }}</div>
                        <div class="col-12"><strong>Localisation:</strong> {{ commande.localisation_client }}</div>
                        <div class="col-12">
                            <strong>Type:</strong>
                            {% if commande.type_commande == 'CITYPROP' %}
                                <span class="badge bg-success"><i class="fa-solid fa-broom"></i> Cityprop</span>
                            {% elif commande.type_commande == 'CLIMATISEUR' %}
                                <span class="badge bg-info text-dark"><i class="fa-solid fa-snowflake"></i> Climatiseur</span>
                            {% else %}
                                <span class="badge bg-warning text-dark"><i class="fa-solid fa-rug"></i> Tapisprop</span>
                            {% endif %}
                        </div>
                        <div class="col-12"><strong>Date création:</strong> {{ commande.date_creation|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
            </div>

            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <i class="fa-solid fa-clipboard-list me-1"></i>Détails {{ commande.get_type_commande_display }}
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#detailsCard">
                        <i class="fa-solid fa-chevron-down"></i>
                    </button>
                </div>
                <div class="card-body collapse show" id="detailsCard">
                    {% if commande.type_commande in 'CITYPROP,CLIMATISEUR' and cityclima %}
                        <p>
                            <strong><i class="fa-solid fa-calendar-check me-1"></i>Intervention:</strong> {{ cityclima.date_intervention|default:"-"|date:"d/m/Y" }}<br>
                            <strong><i class="fa-solid fa-smile-beam me-1"></i>Satisfaction:</strong>
                            {% if cityclima.satisfaction == 'OK' %}<span class="badge bg-success">OK (Satisfait)</span>
                            {% elif cityclima.satisfaction == 'KO_RET' %}<span class="badge bg-warning text-dark">KO - Retouche</span>
                            {% elif cityclima.satisfaction == 'KO_REFUS' %}<span class="badge bg-danger">KO - Refus</span>
                            {% else %}<span class="badge bg-secondary">Non défini</span>{% endif %}
                        </p>
                    {% elif commande.type_commande == 'TAPISPROP' and tapis %}
                        <div class="row g-2">
                            <div class="col-6"><strong><i class="fa-solid fa-truck-loading me-1"></i>Ramassage:</strong> {{ tapis.date_ramassage|default:"-"|date:"d/m/Y" }}</div>
                            <div class="col-6"><strong><i class="fa-solid fa-truck-ramp-box me-1"></i>Livraison:</strong> {{ tapis.date_livraison|default:"-"|date:"d/m/Y" }}</div>
                            <div class="col-6"><strong><i class="fa-solid fa-boxes-stacked me-1"></i>Nb Tapis:</strong> {{ tapis.nombre_tapis|default:"-" }}</div>
                            <div class="col-6"><strong><i class="fa-solid fa-coins me-1"></i>Coût Estimé:</strong> {{ tapis.cout|default:"-" }} FCFA</div>
                            <div class="col-12">
                                <strong><i class="fa-solid fa-tag me-1"></i>Statut:</strong>
                                <span class="badge
                                    {% if tapis.statut == 'NON_RESPECTE' %}bg-danger
                                    {% elif tapis.statut == 'PRET' %}bg-warning text-dark
                                    {% elif tapis.statut == 'CLIENT_INDISPO' %}bg-info text-dark
                                    {% elif tapis.statut == 'LIVRE-satisfait' %}bg-success
                                    {% elif tapis.statut == 'LIVRE-insatisfait' %}bg-danger
                                    {% else %}bg-secondary
                                    {% endif %}">{{ tapis.get_statut_display }}</span>
                            </div>
                            <div class="col-12"><strong><i class="fa-solid fa-comment me-1"></i>Commentaire:</strong> <br>{{ tapis.commentaire|default:"-" }}</div>
                        </div>
                    {% else %}
                        <p class="alert alert-warning">Aucun détail spécifique trouvé pour ce type de commande.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card mt-3 border-info">
                <div class="card-header bg-info text-white">
                    <i class="fa-solid fa-receipt me-1"></i>Factures & Devis Associés
                </div>
                <div class="card-body p-0">
                    {% if factures %}
                        <ul class="list-group list-group-flush small">
                            {% for facture in factures %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        **<span class="text-uppercase">{{ facture.type_document }}</span>** ({{ facture.date_creation|date:"d/m/Y" }}) - 
                                        <em class="text-muted">{{ facture.objet }}</em>
                                    </span>
                                    <a href="{% url 'voir_facture' facture.id %}" class="btn btn-sm btn-outline-primary" title="Voir ou télécharger la facture">
                                        <i class="fa-solid fa-download"></i>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted p-3 mb-0">Aucun document (facture/devis) créé pour cette commande.</p>
                    {% endif %}
                </div>
            </div>

        </div>

        <div class="col-lg-6 col-md-12">
            <div class="card mb-3 border-success">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <i class="fa-solid fa-pen-to-square me-1"></i>Modifier la commande
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#formCard">
                        <i class="fa-solid fa-chevron-down"></i>
                    </button>
                </div>
                <div class="card-body collapse show" id="formCard">
                    <form method="POST" class="row g-2">
                        {% csrf_token %}
                        <div class="col-md-6"><label class="form-label"><i class="fa-solid fa-user me-1"></i>Nom</label>
                            <input type="text" name="nom_client" class="form-control" value="{{ commande.nom_client }}">
                        </div>
                        <div class="col-md-6"><label class="form-label"><i class="fa-solid fa-phone me-1"></i>Numéro</label>
                            <input type="text" name="numero_client" class="form-control" value="{{ commande.numero_client }}">
                        </div>
                        <div class="col-md-12"><label class="form-label"><i class="fa-solid fa-map-marker-alt me-1"></i>Localisation</label>
                            <input type="text" name="localisation_client" class="form-control" value="{{ commande.localisation_client }}">
                        </div>
                        <div class="col-md-12"><label class="form-label"><i class="fa-solid fa-list-check me-1"></i>Type commande</label>
                            <select name="type_commande" class="form-select">
                                <option value="CITYPROP" {% if commande.type_commande == "CITYPROP" %}selected{% endif %}>Cityprop</option>
                                <option value="CLIMATISEUR" {% if commande.type_commande == "CLIMATISEUR" %}selected{% endif %}>Climatiseur</option>
                                <option value="TAPISPROP" {% if commande.type_commande == "TAPISPROP" %}selected{% endif %}>Tapisprop</option>
                            </select>
                        </div>

                        {% if commande.type_commande in 'CITYPROP,CLIMATISEUR' %}
                            <div class="col-md-6"><label class="form-label"><i class="fa-solid fa-calendar-days me-1"></i>Date intervention</label>
                                <input type="date" name="date_intervention" class="form-control" value="{{ cityclima.date_intervention|date:"Y-m-d"|default_if_none:'' }}">
                            </div>
                            <div class="col-md-6"><label class="form-label"><i class="fa-solid fa-smile me-1"></i>Satisfaction</label>
                                <select name="satisfaction" class="form-select">
                                    <option value="">-- Choisir --</option>
                                    <option value="OK" {% if cityclima.satisfaction == 'OK' %}selected{% endif %}>OK</option>
                                    <option value="KO_RET" {% if cityclima.satisfaction == 'KO_RET' %}selected{% endif %}>KO - Retouche</option>
                                    <option value="KO_REFUS" {% if cityclima.satisfaction == 'KO_REFUS' %}selected{% endif %}>KO - Refus</option>
                                </select>
                            </div>
                        {% elif commande.type_commande == 'TAPISPROP' %}
                            <div class="col-md-6"><label class="form-label"><i class="fa-solid fa-truck me-1"></i>Date Ramassage</label>
                                <input type="date" name="date_ramassage" class="form-control" value="{{ tapis.date_ramassage|date:"Y-m-d"|default_if_none:'' }}">
                            </div>
                            <div class="col-md-6"><label class="form-label"><i class="fa-solid fa-truck-fast me-1"></i>Date Livraison</label>
                                <input type="date" name="date_livraison" class="form-control" value="{{ tapis.date_livraison|date:"Y-m-d"|default_if_none:'' }}">
                            </div>
                            <div class="col-md-4"><label class="form-label"><i class="fa-solid fa-boxes-stacked me-1"></i>Nb Tapis</label>
                                <input type="number" name="nombre_tapis" class="form-control" value="{{ tapis.nombre_tapis|default_if_none:'' }}">
                            </div>
                            <div class="col-md-4"><label class="form-label"><i class="fa-solid fa-money-bill-wave me-1"></i>Coût</label>
                                <input type="number" name="cout" class="form-control" value="{{ tapis.cout|default_if_none:'' }}">
                            </div>
                            <div class="col-md-4"><label class="form-label"><i class="fa-solid fa-calendar-check me-1"></i>Fin Traitement</label>
                                <input type="date" name="date_traitement" class="form-control" value="{{ tapis.date_traitement|date:"Y-m-d"|default_if_none:'' }}">
                            </div>
                            <div class="col-md-12"><label class="form-label"><i class="fa-solid fa-info me-1"></i>Statut</label>
                                <select name="statut" class="form-select">
                                    <option value="NON_RESPECTE" {% if tapis.statut == 'NON_RESPECTE' %}selected{% endif %}>Délai non respecté</option>
                                    <option value="PRET" {% if tapis.statut == 'PRET' %}selected{% endif %}>En attente</option>
                                    <option value="CLIENT_INDISPO" {% if tapis.statut == 'CLIENT_INDISPO' %}selected{% endif %}>Client indisponible</option>
                                    <option value="LIVRE-satisfait" {% if tapis.statut == 'LIVRE-satisfait' %}selected{% endif %}>Livré satisfait</option>
                                    <option value="LIVRE-insatisfait" {% if tapis.statut == 'LIVRE-insatisfait' %}selected{% endif %}>Livré insatisfait</option>
                                </select>
                            </div>
                            <div class="col-12"><label class="form-label"><i class="fa-solid fa-comment-dots me-1"></i>Commentaire</label>
                                <textarea name="commentaire" class="form-control">{{ tapis.commentaire|default_if_none:'' }}</textarea>
                            </div>
                        {% endif %}

                        <div class="col-12 mt-3 d-flex justify-content-between">
                            <button type="submit" class="btn btn-success"><i class="fa-solid fa-floppy-disk me-1"></i>Mettre à jour</button>
                            <a href="{% url 'liste_fiches' %}" class="btn btn-secondary"><i class="fa-solid fa-arrow-left me-1"></i>Retour à la liste</a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="d-grid mt-3">
                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#factureModal">
                    <i class="fa-solid fa-file-invoice me-1"></i> Générer Facture / Devis
                </button>
            </div>

        </div>

    </div>
</div>

<div class="modal fade" id="factureModal" tabindex="-1" aria-labelledby="factureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="POST" action="{% url 'creer_facture' fiche_id=commande.id %}">
                {% csrf_token %}
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="factureModalLabel"><i class="fa-solid fa-plus me-2"></i>Créer Facture/Devis pour **{{ commande.nom_client }}**</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label small">Type de document</label>
                            <select name="type_document" class="form-select form-select-sm">
                                <option value="DEVIS">DEVIS</option>
                                <option value="FACTURE">FACTURE</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small">Objet du document</label>
                            <input type="text" name="objet" class="form-control form-control-sm" placeholder="Ex: Nettoyage canapés et chaises / Prestation Clim">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Lieu d'émission</label>
                            <input type="text" name="lieu_emission" class="form-control form-control-sm" value="Abidjan">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Signature (Rôle)</label>
                            <input type="text" name="signature" class="form-control form-control-sm" placeholder="Ex: LA COMPTABILITÉ">
                        </div>
                    </div>

                    <h6 class="mb-2 text-primary"><i class="fa-solid fa-list-ol me-1"></i>Lignes de Prestation</h6>
                    <hr class="mt-0">

                    <div class="row g-2 small text-muted mb-1 fw-bold">
                        <div class="col-4">Désignation</div>
                        <div class="col-2 text-end">Quantité</div>
                        <div class="col-3 text-end">Prix Unitaire</div>
                        <div class="col-3">Note Prix (Optionnel)</div>
                    </div>
                    
                    <div id="lignesFacture">
                        <div class="row g-2 ligne-facture align-items-center">
                            <div class="col-4">
                                <input type="text" name="designation[]" class="form-control form-control-sm" placeholder="Désignation de la prestation">
                            </div>
                            <div class="col-2">
                                <input type="number" name="quantite[]" class="form-control form-control-sm text-end" placeholder="Qté" value="1" min="1">
                            </div>
                            <div class="col-2">
                                <input type="number" name="prix_unitaire[]" class="form-control form-control-sm text-end" placeholder="Prix Unitaire" min="0">
                            </div>
                            <div class="col-3">
                                <input type="text" name="note_prix[]" class="form-control form-control-sm" placeholder="Ex: HT, /jour">
                            </div>
                            <div class="col-1">
                                <button type="button" class="btn btn-danger btn-sm w-100 remove-line" title="Supprimer cette ligne">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-sm btn-secondary mt-2" id="ajouterLigne">
                        <i class="fa-solid fa-plus me-1"></i> Ajouter une ligne de prestation
                    </button>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">
                        <i class="fa-solid fa-file-invoice-dollar me-1"></i> Générer et Télécharger
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const lignesFactureContainer = document.getElementById('lignesFacture');
    const ajouterLigneBtn = document.getElementById('ajouterLigne');

    // Fonction pour supprimer une ligne
    const setupRemoveLine = (lineElement) => {
        lineElement.querySelector('.remove-line').addEventListener('click', function() {
            // S'assurer qu'au moins une ligne reste
            if (lignesFactureContainer.children.length > 1) {
                lineElement.remove();
            } else {
                alert("Vous devez conserver au moins une ligne de prestation.");
            }
        });
    };

    // Initialiser le bouton de suppression pour la première ligne (celle clonée)
    document.querySelectorAll('.ligne-facture').forEach(setupRemoveLine);

    // Ajouter une nouvelle ligne
    ajouterLigneBtn.addEventListener('click', function(){
        // Clone la dernière ligne existante
        const lastLigne = lignesFactureContainer.lastElementChild;
        const newLigne = lastLigne.cloneNode(true);
        
        // Réinitialiser les valeurs de la nouvelle ligne (sauf Quantité à 1)
        newLigne.querySelectorAll('input').forEach(input => {
            if (input.name.includes('quantite')) {
                input.value = '1'; 
            } else {
                input.value = '';
            }
        });

        // Supprimer l'ancien écouteur et en ajouter un nouveau
        const removeBtn = newLigne.querySelector('.remove-line');
        const newRemoveBtn = removeBtn.cloneNode(true); // Clone le bouton pour enlever l'ancien event listener
        removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

        // Ajouter la nouvelle ligne au conteneur
        lignesFactureContainer.appendChild(newLigne);
        
        // Configurer l'écouteur de suppression pour la nouvelle ligne
        setupRemoveLine(newLigne);
    });
});
</script>
{% endblock %}