{% extends "base.html" %}
{% block title %}Commandes{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    :root { --small-font: 12.5px; }
    body { font-size: var(--small-font); background-color: #f4f7f6; }
    
    /* Table Styles */
    .compact-table th { background-color: #2d3436 !important; color: white; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; }
    .compact-table td { padding: 4px 8px !important; vertical-align: middle; }
    
    /* UI Components */
    .filter-bar { background: #fff; border-radius: 8px; border: 1px solid #dfe6e9; }
    .form-control-sm, .form-select-sm { font-size: 10px; border-radius: 4px; }
    .badge-status { font-size: 10px; padding: 3px 7px; border-radius: 12px; font-weight: 600; }
    
    .btn-icon { width: 30px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
    .btn-edit { border: 1px solid #0d6efd; color: #0d6efd; background: white; }
    .btn-edit:hover { background: #0d6efd; color: white; }
    
    .search-container { position: relative; }
    .search-container i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #b2bec3; }
    .search-container input { padding-left: 30px; }

    .date-range-group { display: flex; gap: 4px; }
    .date-range-group input { flex: 1; min-width: 90px; }

    /* Progress Bar */
    .prog-container { width: 100%; background: #eee; border-radius: 10px; height: 12px; margin: 10px 0; overflow: hidden; display: none; }
    .prog-bar { width: 0%; height: 100%; background: #0d6efd; transition: width 0.2s; }
    
    /* State Styles */
    .text-late { color: #d63031; font-weight: bold; } 
    .label-filter { display: block; mb: 1px; text-muted; font-size: 9px; text-transform: uppercase; font-weight: 600; }
</style>

<div class="container-fluid mt-2 px-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-list-check me-2 text-primary"></i>LISTE DES COMMANDES</h6>
        <div class="d-flex gap-2">
            <form method="GET" action="{% url 'liste_fiches' %}" id="searchForm">
                <div class="search-container">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" name="q" id="quickSearch" value="{{ search_query }}" class="form-control form-control-sm border-0 shadow-sm" style="width: 200px;" placeholder="Client, numéro, lieu...">
                </div>
            </form>
            <button type="button" onclick="showImportModal()" class="btn btn-primary btn-sm shadow-sm px-3 d-flex align-items-center gap-2">
                <i class="fa-solid fa-file-import"></i> <span>Importer</span>
            </button>
            <a href="{% url 'export_commandes_excel' %}?{{ request.GET.urlencode }}" class="btn btn-success btn-sm shadow-sm px-3 d-flex align-items-center gap-2">
                <i class="fa-solid fa-file-excel"></i> <span>Exporter</span>
            </a>
        </div>
    </div>

    <form method="GET" class="filter-bar p-2 mb-2 shadow-sm border-0">
        <div class="row g-2 align-items-end">
            <div class="col-md-2">
                <label class="label-filter text-muted">Client / Nom</label>
                <input type="text" name="nom_client" value="{{ nom_filter }}" class="form-control form-control-sm" placeholder="Rechercher...">
            </div>
            <div class="col-md-1">
                <label class="label-filter text-muted">Type</label>
                <select name="type_commande" class="form-select form-select-sm">
                    <option value="">Tous</option>
                    <option value="CITYPROP" {% if type_filter == "CITYPROP" %}selected{% endif %}>Cityprop</option>
                    <option value="CLIMATISEUR" {% if type_filter == "CLIMATISEUR" %}selected{% endif %}>Clim</option>
                    <option value="TAPISPROP" {% if type_filter == "TAPISPROP" %}selected{% endif %}>Tapis</option>
                </select>
            </div>
            
            <div class="col-md-1">
                <label class="label-filter text-primary">Date Saisie</label>
                <input type="date" name="date_crea" value="{{ date_crea }}" class="form-control form-control-sm border-primary">
            </div>

            <div class="col-md-3">
                <label class="label-filter text-muted">Plage d'Opération (Ramassage / Interv.)</label>
                <div class="date-range-group">
                    <input type="date" name="date_debut" value="{{ date_debut }}" class="form-control form-control-sm" title="Début">
                    <input type="date" name="date_fin" value="{{ date_fin }}" class="form-control form-control-sm" title="Fin">
                </div>
            </div>

            <div class="col-md-2">
                <label class="label-filter text-muted">Statut / Satisfaction</label>
                <select name="statut" class="form-select form-select-sm">
                    <option value="">Statut (Tous)</option>
                    <option value="NON_RESPECTE" {% if statut_filter == "NON_RESPECTE" %}selected{% endif %}>En cours</option>
                    <option value="PRET" {% if statut_filter == "PRET" %}selected{% endif %}>En attente</option>
                    <option value="CLIENT_INDISPO" {% if statut_filter == "CLIENT_INDISPO" %}selected{% endif %}>Tapis Prêt client indisponible</option>
                    <option value="LIVRE-satisfait" {% if statut_filter == "LIVRE-satisfait" %}selected{% endif %}>Livré - client satisfait</option>
                    <option value="LIVRE-insatisfait" {% if statut_filter == "LIVRE-insatisfait" %}selected{% endif %}>Livré - client insatisfait</option>
                    <option value="ABANDON" {% if statut_filter == "ABANDON" %}selected{% endif %}>Tapis Abandonné</option>
                    <option value="KO_RET" {% if statut_filter == "KO_RET" %}selected{% endif %}>KO - Retouche</option>
                    <option value="OK" {% if statut_filter == "OK" %}selected{% endif %}>OK</option>
                    <option value="KO_REFUS" {% if statut_filter == "KO_REFUS" %}selected{% endif %}>KO - Refus</option>
                </select>
            </div>

            <div class="col-md-1">
                <label class="label-filter text-muted">Fidélisé</label>
                <select name="fidelise" class="form-select form-select-sm">
                    <option value="">-</option>
                    <option value="oui" {% if fidelise_filter == "oui" %}selected{% endif %}>Oui</option>
                    <option value="non" {% if fidelise_filter == "non" %}selected{% endif %}>Non</option>
                </select>
            </div>

            <div class="col-md-2 d-flex gap-1">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1 fw-bold">Filtrer</button>
                <a href="{% url 'liste_fiches' %}" class="btn btn-outline-secondary btn-sm" title="Réinitialiser"><i class="fa-solid fa-rotate-left"></i></a>
            </div>
        </div>
    </form>

    <div class="table-responsive bg-white rounded shadow-sm border">
        <table class="table table-hover compact-table mb-0">
            <thead>
                <tr class="text-center">
                    <th class="text-start ps-3">Information Client</th>
                    <th>Type</th>
                    <th>Date D'intervention / Ramassage 
                    </th>
                    <th>Localisation / Suivi Détail</th>
                    <th>Fidélité</th>
                    <th style="width: 90px;">Actions</th>
                </tr>
            </thead>
            <tbody class="text-center">
                {% for c in commandes %}
                <tr>
                    <td class="text-start ps-3">
                        <div class="fw-bold text-dark">{{ c.nom_client }}</div>
                        <div class="text-muted" style="font-size: 10px;">
                            <i class="fa-solid fa-phone me-1"></i>{{ c.numero_client }} 
                            <span class="ms-1 text-light-emphasis">| Créé le {{ c.date_creation|date:"d/m/y" }}</span>
                        </div>
                    </td>
                    <td>
                        {% if c.type_commande == 'CITYPROP' %}
                            <span class="badge-status bg-success text-white">CITYPROP</span>
                        {% elif c.type_commande == 'CLIMATISEUR' %}
                            <span class="badge-status bg-info text-dark">CLIM</span>
                        {% else %}
                            <span class="badge-status bg-warning text-dark">TAPIS</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if c.type_commande == 'TAPISPROP' %}
                            {% if c.tapisdetails %}
                                <span class="{% if c.tapisdetails.date_ramassage < today %}text-late{% endif %}">
                                    {{ c.tapisdetails.date_ramassage|date:"d/m/y"|default:"-" }}
                                </span>
                            {% else %}-{% endif %}
                        {% else %}
                            {% if c.cityclimadetails %}
                                <span class="{% if c.cityclimadetails.date_intervention < today %}text-late{% endif %}">
                                    {{ c.cityclimadetails.date_intervention|date:"d/m/y"|default:"-" }}
                                </span>
                            {% else %}-{% endif %}
                        {% endif %}
                    </td>
                    <td class="text-start" style="max-width:280px;">
                        <div class="text-truncate" style="font-size: 11px;"><i class="fa-solid fa-location-dot me-1 text-muted"></i>{{ c.localisation_client }}</div>
                        <div class="mt-1" style="font-size: 10px; color: #636e72;">
                            {% if c.type_commande == 'TAPISPROP' and c.tapisdetails %}
                                <b>Statut:</b> {{ c.tapisdetails.get_statut_display }}
                            {% elif c.cityclimadetails %}
                                <b>Satisfaction:</b> {{ c.cityclimadetails.satisfaction|default:"-" }}
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if c.type_commande == 'TAPISPROP' and c.tapisdetails.fidelise %}
                            <a href="{% url 'detail_fidelisation' c.tapisdetails.id %}" class="text-decoration-none"><span class="badge bg-soft-success text-success border border-success px-2" style="font-size: 9px;">OUI</span></a>
                        {% elif c.cityclimadetails.fidelise %}
                            <a href="{% url 'detail_fidelisation' c.cityclimadetails.id %}" class="text-decoration-none"><span class="badge bg-soft-success text-success border border-success px-2" style="font-size: 9px;">OUI</span></a>
                        {% else %}
                            <span class="text-muted opacity-50" style="font-size: 9px;">NON</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="{% url 'detail_fiche' c.id %}" class="btn-icon btn-edit" title="Modifier"><i class="fa-solid fa-pen-to-square"></i></a>
                            <form action="{% url 'supprimer_commande' c.id %}" method="POST" class="delete-form" data-client="{{ c.nom_client|escapejs }}">
                                {% csrf_token %}
                                <button type="button" class="btn-icon btn-outline-danger btn-delete-trigger"><i class="fa-solid fa-trash-can"></i></button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="py-5 text-muted fst-italic text-center">Aucune commande ne correspond à vos critères.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if commandes.has_other_pages %}
    <div class="d-flex justify-content-center mt-3">
        <nav>
            <ul class="pagination pagination-sm shadow-sm border-0">
                {% if commandes.has_previous %}
                    <li class="page-item"><a class="page-link border-0 text-dark" href="?page={{ commandes.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode|cut:'page=' }}{% endif %}"><i class="fa-solid fa-chevron-left"></i></a></li>
                {% endif %}
                <li class="page-item disabled"><span class="page-link px-3 fw-bold text-primary border-0 bg-white">Page {{ commandes.number }} / {{ commandes.paginator.num_pages }}</span></li>
                {% if commandes.has_next %}
                    <li class="page-item"><a class="page-link border-0 text-dark" href="?page={{ commandes.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode|cut:'page=' }}{% endif %}"><i class="fa-solid fa-chevron-right"></i></a></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
    // 1. RECHERCHE INSTANTANÉE
    let searchTimeout = null;
    document.getElementById("quickSearch").addEventListener("input", function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { document.getElementById("searchForm").submit(); }, 600);
    });

    // 2. MODAL D'IMPORTATION
    function showImportModal() {
        Swal.fire({
            title: 'Importer un fichier Excel',
            html: `
                <div class="text-start" style="font-size:12px;">
                    <div class="alert alert-info p-2 mb-3">
                        <i class="fa-solid fa-download me-1"></i> <a href="{% url 'generer_modele_excel' %}" class="fw-bold">Télécharger le modèle (.xlsx)</a>
                    </div>
                    <label class="mb-1 fw-bold">Sélectionner le fichier :</label>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" class="form-control form-control-sm mb-3">
                    <div id="progCont" class="prog-container"><div id="progB" class="prog-bar"></div></div>
                    <small id="statusMsg" class="text-primary fw-bold" style="display:none;">Traitement en cours...</small>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Lancer l\'importation',
            preConfirm: () => {
                const file = document.getElementById('fileInput').files[0];
                if (!file) { Swal.showValidationMessage('Veuillez sélectionner un fichier'); return false; }
                document.getElementById('progCont').style.display = 'block';
                document.getElementById('statusMsg').style.display = 'block';
                
                let formData = new FormData();
                formData.append('file', file);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                
                return fetch("{% url 'import_commandes_ajax' %}", { method: 'POST', body: formData })
                .then(response => {
                    if (!response.ok) throw new Error('Erreur lors de l\'importation');
                    return response.json();
                }).catch(error => { Swal.showValidationMessage(`Erreur: ${error}`); });
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                Swal.fire('Succès !', result.value.message, 'success').then(() => location.reload());
            }
        });
    }

    // 3. CONFIRMATION DE SUPPRESSION
    document.querySelectorAll('.btn-delete-trigger').forEach(btn => {
        btn.addEventListener('click', function() {
            const form = this.closest('.delete-form');
            const client = form.getAttribute('data-client');
            Swal.fire({
                title: 'Suppression définitive',
                text: `Voulez-vous vraiment supprimer la fiche de ${client} ?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Oui, supprimer',
                cancelButtonText: 'Annuler'
            }).then((result) => { if (result.isConfirmed) form.submit(); });
        });
    });
</script>
{% endblock %}