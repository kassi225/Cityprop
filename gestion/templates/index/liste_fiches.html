{% extends "base.html" %}
{% block title %}Commandes{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    :root { --small-font: 12.5px; }
    body { font-size: var(--small-font); background-color: #f4f7f6; }
    .compact-table th { background-color: #2d3436 !important; color: white; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
    .compact-table td { padding: 4px 8px !important; vertical-align: middle; }
    .filter-bar { background: #fff; border-radius: 8px; border: 1px solid #dfe6e9; }
    .form-control-sm, .form-select-sm { font-size: 12px; border-radius: 4px; }
    .badge-status { font-size: 10px; padding: 3px 7px; border-radius: 12px; font-weight: 600; }
    
    /* Boutons d'action compacts et visibles */
    .btn-icon { width: 30px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
    .btn-edit { border: 1px solid #0d6efd; color: #0d6efd; background: white; }
    .btn-edit:hover { background: #0d6efd; color: white; }
    
    .search-container { position: relative; }
    .search-container i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #b2bec3; }
    .search-container input { padding-left: 30px; }
</style>

<div class="container-fluid mt-2 px-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-list-check me-2 text-primary"></i>COMMANDES</h6>
        <div class="d-flex gap-2">
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="quickSearch" class="form-control form-control-sm border-0 shadow-sm" style="width: 220px;" placeholder="Recherche rapide...">
            </div>
            <a href="{% url 'export_commandes_excel' %}?{{ request.GET.urlencode }}" class="btn btn-success btn-sm shadow-sm d-flex align-items-center gap-2 px-3">
                <i class="fa-solid fa-file-excel"></i>
                <span class="fw-bold" style="font-size: 11px;">Exporter Excel</span>
            </a>
        </div>
    </div>

    <form method="GET" class="filter-bar p-2 mb-2 shadow-sm">
        <div class="row g-2 align-items-end">
            <div class="col-md-2">
                <input type="text" name="nom_client" value="{{ nom_filter }}" class="form-control form-control-sm" placeholder="Client">
            </div>
            <div class="col-md-1">
                <input type="text" name="numero_client" value="{{ numero_filter }}" class="form-control form-control-sm" placeholder="Numéro">
            </div>
            <div class="col-md-1">
                <select name="type_commande" class="form-select form-select-sm">
                    <option value="">Type (Tous)</option>
                    <option value="CITYPROP" {% if type_filter == "CITYPROP" %}selected{% endif %}>Cityprop</option>
                    <option value="CLIMATISEUR" {% if type_filter == "CLIMATISEUR" %}selected{% endif %}>Clim</option>
                    <option value="TAPISPROP" {% if type_filter == "TAPISPROP" %}selected{% endif %}>Tapis</option>
                </select>
            </div>
            <div class="col-md-2">
                <select name="statut" class="form-select form-select-sm">
                    <option value="">Statut (Tous)</option>
                    <option value="NON_RESPECTE" {% if statut_filter == "NON_RESPECTE" %}selected{% endif %}>En cours</option>
                    <option value="PRET" {% if statut_filter == "PRET" %}selected{% endif %}>En attente</option>
                    <option value="CLIENT_INDISPO" {% if statut_filter == "CLIENT_INDISPO" %}selected{% endif %}>Prêt / Indispo</option>
                    <option value="LIVRE-satisfait" {% if statut_filter == "LIVRE-satisfait" %}selected{% endif %}>Livré satisfait</option>
                    <option value="LIVRE-insatisfait" {% if statut_filter == "LIVRE-insatisfait" %}selected{% endif %}>Livré insatisfait</option>
                </select>
            </div>
            <div class="col-md-2 d-flex gap-1">
                <input type="date" name="date_debut" value="{{ date_debut }}" class="form-control form-control-sm">
                <input type="date" name="date_fin" value="{{ date_fin }}" class="form-control form-control-sm">
            </div>
            <div class="col-md-1">
                <select name="fidelise" class="form-select form-select-sm">
                    <option value="">Fidélisé ?</option>
                    <option value="oui" {% if fidelise_filter == "oui" %}selected{% endif %}>Oui</option>
                    <option value="non" {% if fidelise_filter == "non" %}selected{% endif %}>Non</option>
                </select>
            </div>
            <div class="col-md-2 d-flex gap-1">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1 fw-bold">Filtrer</button>
                <a href="{% url 'liste_fiches' %}" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-rotate-left"></i></a>
            </div>
        </div>
    </form>

    <div class="table-responsive bg-white rounded shadow-sm border">
        <table class="table table-hover compact-table mb-0">
            <thead>
                <tr class="text-center">
                    <th class="text-start ps-3">Client</th>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Localisation / Suivi</th>
                    <th>Fidélité</th>
                    <th style="width: 100px;">Actions</th>
                </tr>
            </thead>
            <tbody class="text-center">
                {% for c in commandes %}
                <tr>
                    <td class="text-start ps-3">
                        <div class="fw-bold text-dark">{{ c.nom_client }}</div>
                        <div class="text-muted" style="font-size: 11px;">{{ c.numero_client }}</div>
                    </td>
                    <td>
                        {% if c.type_commande == 'CITYPROP' %}
                            <span class="badge-status bg-success text-white">CITYPROP</span>
                        {% elif c.type_commande == 'CLIMATISEUR' %}
                            <span class="badge-status bg-info text-dark">CLIM</span>
                        {% else %}
                            <span class="badge-status bg-warning text-dark">TAPIS</span>
                        {% endif %}
                    </td>
                    <td class="text-muted">{{ c.date_creation|date:"d/m/y" }}</td>
                    <td class="text-start" style="max-width:280px;">
                        <div class="text-truncate" style="font-size: 11px;"><i class="fa-solid fa-location-dot me-1 text-muted"></i>{{ c.localisation_client }}</div>
                        <div class="mt-1" style="font-size: 10px; color: #636e72;">
                            {% if c.type_commande != 'TAPISPROP' and c.cityclimadetails %}
                                <b>Interv:</b> {{ c.cityclimadetails.date_intervention|default:"-" }} | <b>Sat:</b> {{ c.cityclimadetails.satisfaction|default:"-" }}
                            {% elif c.tapisdetails %}
                                <b>Livraison:</b> {{ c.tapisdetails.date_livraison|default:"-" }} | <b>Etat:</b> {{ c.tapisdetails.get_statut_display }}
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if c.cityclimadetails.fidelise or c.tapisdetails.fidelise %}
                            <span class="badge bg-soft-success text-success border border-success px-2" style="font-size: 9px;">
                                <i class="fa-solid fa-star me-1"></i>OUI
                            </span>
                        {% else %}
                            <span class="text-muted opacity-50" style="font-size: 9px;">NON</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="{% url 'detail_fiche' c.id %}" class="btn-icon btn-edit" title="Éditer la fiche">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </a>
                            {% if request.user.is_superuser or request.user.groups.all.0.name == "ADMIN" %}
                            <form action="{% url 'supprimer_commande' c.id %}" method="POST" class="delete-form" data-client="{{ c.nom_client|escapejs }}">
                                {% csrf_token %}
                                <button type="button" class="btn-icon btn-outline-danger btn-delete-trigger" title="Supprimer">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="py-5 text-muted fst-italic">Aucune commande ne correspond à vos critères</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if commandes.has_other_pages %}
    <div class="d-flex justify-content-center mt-3">
        <nav>
            <ul class="pagination pagination-sm shadow-sm border-0">
                {% if commandes.has_previous %}
                    <li class="page-item"><a class="page-link border-0 text-dark" href="?page={{ commandes.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode|cut:'page=' }}{% endif %}"><i class="fa-solid fa-chevron-left"></i></a></li>
                {% endif %}
                <li class="page-item disabled"><span class="page-link px-3 fw-bold text-primary border-0 bg-white">Page {{ commandes.number }} / {{ commandes.paginator.num_pages }}</span></li>
                {% if commandes.has_next %}
                    <li class="page-item"><a class="page-link border-0 text-dark" href="?page={{ commandes.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode|cut:'page=' }}{% endif %}"><i class="fa-solid fa-chevron-right"></i></a></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
    // Recherche rapide instantanée
    document.getElementById("quickSearch").addEventListener("keyup", function () {
        let value = this.value.toLowerCase();
        document.querySelectorAll("tbody tr").forEach(row => {
            if (!row.innerText.includes("Aucune commande")) {
                row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
            }
        });
    });

    // Alertes de suppression SweetAlert2
    document.querySelectorAll('.btn-delete-trigger').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const form = this.closest('.delete-form');
            const client = form.getAttribute('data-client');
            Swal.fire({
                title: 'Supprimer ?',
                text: `Confirmez-vous la suppression pour ${client} ?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Oui, supprimer !',
                cancelButtonText: 'Annuler',
                heightAuto: false
            }).then((result) => { if (result.isConfirmed) form.submit(); });
        });
    });
</script>
{% endblock %}