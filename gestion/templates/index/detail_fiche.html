{% extends "base.html" %}
{% load static %}
{% block title %}Fiche Client - {{ commande.nom_client }}{% endblock %}

{% block content %}

<style>
/* Styles g√©n√©raux optimis√©s */
body { font-size: 1rem; background-color: #f4f7f6; }
.card { border-radius: 0.75rem; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.card:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.12); }
.card-header { border-bottom: none; border-radius: 0.75rem 0.75rem 0 0 !important; font-weight: 700; padding: 0.75rem 1.25rem; }
.form-label { font-weight: 600; margin-bottom: 0.25rem; color: #343a40; }
input, select, textarea { font-size: 0.85rem; padding: 0.5rem 0.75rem; border-radius: 0.5rem; }
.total-ligne-display, #totalHTFacture, #totalFinalFacture { 
    font-weight: bold !important; 
    background-color: #e9ecef !important; /* Gris clair pour les champs calcul√©s */
    border: 1px solid #ced4da;
    border-radius: 0.5rem;
}
.total-ligne-display { color: #007bff; }
#totalFinalFacture { color: #28a745; font-size: 1.2rem; }

/* Styles pour les champs sp√©cifiques aux types de commande */
.commande-specific-fields {
    border-left: 3px solid #17a2b8; /* Une barre pour distinguer les champs sp√©cifiques */
    padding-left: 10px;
    margin-top: 15px;
}
</style>

<div class="container" style="margin-top: 0.2rem !important; margin-bottom: 0.5rem !important;">
    <div class="d-flex align-items-center justify-content-between pb-3 mb-4 border-bottom">
    <div class="d-flex align-items-center">
        <div class="bg-primary bg-opacity-10 p-2 rounded-3 me-3">
            <i class="fa-solid fa-file-invoice fs-4 text-primary"></i>
        </div>
        <div>
            <h4 class="mb-0 fw-bold text-dark text-uppercase" style="letter-spacing: 0.5px;">
                {{ commande.nom_client }}
            </h4>
            <span class="badge bg-light text-secondary border fw-normal">ID #{{ commande.id }}</span>
        </div>
    </div>
    <div class="text-muted small">
        <i class="fa-regular fa-calendar me-1"></i> {{ commande.date_creation|date:"d/m/Y" }}
    </div>
</div>

    <div class="row g-4">
        <div class="col-lg-6 col-md-12">

            <div class="card mb-4 border-primary shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-info-circle me-1"></i> Infos client & commande</span>
                    <button class="btn btn-sm btn-light p-1" type="button" data-bs-toggle="collapse" data-bs-target="#infosGen">
                        <i class="fa-solid fa-chevron-down fa-fw"></i>
                    </button>
                </div>
                <div class="card-body collapse show" id="infosGen">
                    <div class="row g-2 small">
                        <div class="col-6"><strong>Nom:</strong> {{ commande.nom_client }}</div>
                        <div class="col-6"><strong>Num√©ro:</strong> {{ commande.numero_client }}</div>
                        <div class="col-12"><strong>Localisation:</strong> {{ commande.localisation_client }}</div>
                        <div class="col-6">
                            <strong>Type:</strong>
                            {% if commande.type_commande == 'CITYPROP' %}
                                <span class="badge bg-success">Cityprop</span>
                            {% elif commande.type_commande == 'CLIMATISEUR' %}
                                <span class="badge bg-info text-dark">Climatiseur</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Tapisprop</span>
                            {% endif %}
                        </div>
                        <div class="col-6"><strong>Cr√©√©e le:</strong> {{ commande.date_creation|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
            </div>

            <div class="card mb-4 border-secondary shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-clipboard-list me-1"></i> D√©tails {{ commande.get_type_commande_display }}</span>
                    <button class="btn btn-sm btn-light p-1" type="button" data-bs-toggle="collapse" data-bs-target="#detailsCard">
                        <i class="fa-solid fa-chevron-down fa-fw"></i>
                    </button>
                </div>
                <div class="card-body collapse show" id="detailsCard">
                    {% if commande.type_commande == 'CITYPROP' or commande.type_commande == 'CLIMATISEUR' %}
    {% if cityclima %}
    <div class="detail-section bg-white p-3 rounded border shadow-sm mt-3">
        <h6 class="border-bottom pb-2 mb-3 text-uppercase small fw-bold text-secondary">
            <i class="fas fa-tools me-2"></i>D√©tails Intervention Clima
        </h6>
        <div class="row g-3 small">
            <div class="col-6">
                <div class="text-muted mb-1">Co√ªt de la prestation</div>
                <span class="fs-6 fw-bold text-success">{{ cityclima.cout|default:"0" }} FCFA</span>
            </div>
            <div class="col-6 text-end">
                <div class="text-muted mb-1">Date Intervention</div>
                <span class="fw-bold"><i class="far fa-calendar-alt me-1"></i>{{ cityclima.date_intervention|default:"-"|date:"d/m/Y" }}</span>
            </div>

            <div class="col-12">
                <div class="p-2 rounded bg-light border-start border-4 border-info">
                    <div class="text-muted mb-1 fw-bold">D√©signation des √©quipements</div>
                    <div class="fst-italic text-dark">{{ cityclima.designation|default:"Aucune description fournie." }}</div>
                </div>
            </div>

            <div class="col-12 d-flex justify-content-between align-items-center mt-2">
                <strong>√âtat de satisfaction :</strong>
                <span class="badge rounded-pill {% if cityclima.satisfaction == 'OK' %}bg-success text-white px-3{% else %}bg-warning text-dark px-3{% endif %}">
                    {{ cityclima.get_satisfaction_display|default:"Non d√©finie" }}
                </span>
            </div>
        </div>
    </div>
    {% endif %}

    {% elif commande.type_commande == 'TAPISPROP' and tapis %}
        <div class="detail-section bg-white p-3 rounded border shadow-sm mt-3">
            <h6 class="border-bottom pb-2 mb-3 text-uppercase small fw-bold text-secondary">
                <i class="fas fa-rug me-2"></i>Suivi Traitement Tapis
            </h6>
            <div class="row g-3 small">
                <div class="col-6 col-md-3">
                    <div class="text-muted small">Ramassage</div>
                    <div class="fw-bold text-primary"><i class="fas fa-truck-loading me-1"></i>{{ tapis.date_ramassage|date:"d/m/Y"|default:"-" }}</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="text-muted small">Fin de traitement </div>
                    <div class="fw-bold text-danger"><i class="fas fa-check-circle me-1"></i>{{ tapis.date_traitement|date:"d/m/Y"|default:"-" }}</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="text-muted small">Pr√©vu le</div>
                    <div class="fw-bold text-warning"><i class="fas fa-clock me-1"></i>{{ tapis.date_prevue_livraison|date:"d/m/Y"|default:"-" }}</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="text-muted small">Livr√© le</div>
                    <div class="fw-bold text-success"><i class="fas fa-home me-1"></i>{{ tapis.date_livraison|date:"d/m/Y"|default:"-" }}</div>
                </div>

                <div class="col-6">
                    <div class="p-2 bg-light rounded text-center border">
                        <span class="text-muted">Nombre de Tapis:</span> <span class="fw-bold">{{ tapis.nombre_tapis }} Tapis</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-2 bg-light rounded text-center border">
                        <span class="text-muted">cout :</span> <span class="fw-bold text-success">{{ tapis.cout }} FCFA</span>
                    </div>
                </div>

                <div class="col-12 mt-2">
                    <div class="d-flex align-items-center">
                        <span class="me-2">Statut :</span>
                        <span class="badge bg-dark w-100 py-2">{{ tapis.get_statut_display }}</span>
                    </div>
                </div>
                
                {% if tapis.commentaire %}
                <div class="col-12">
                    <div class="small text-muted mb-1 fw-bold"><i class="far fa-comment-dots me-1"></i>Note interne :</div>
                    <div class="p-2 border-start border-3 bg-light rounded-end">{{ tapis.commentaire }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
                </div>
            </div>

            <div class="card border-info shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-receipt me-1"></i> Documents ({{ factures|length }})</span>
                    <button class="btn btn-sm btn-light p-1" type="button" data-bs-toggle="collapse" data-bs-target="#facturesCard">
                        <i class="fa-solid fa-chevron-down fa-fw"></i>
                    </button>
                </div>
                



                <ul class="list-group list-group-flush small">
    {% for f in factures %}
        <li class="list-group-item d-flex justify-content-between align-items-center py-2">
            <span>
                <b class="text-uppercase text-primary">{{ f.type_document }}</b> 
                <span class="text-muted">({{ f.date_emission|date:"d/m/Y" }})</span><br>
                <strong class="text-dark">{{ f.montant_final_net|default:"0" }} FCFA</strong>
            </span>
            
            <div class="btn-group shadow-sm">
                {% if f.id %}
                    <a href="{% url 'voir_facture' f.id %}" class="btn btn-sm btn-outline-primary" title="Voir PDF">
                        <i class="fa-solid fa-eye"></i>
                    </a>
                {% endif %}

                <button type="button" 
                        class="btn btn-sm btn-outline-warning btn-edit-facture" 
                        data-id="{{ f.id }}" 
                        title="Modifier">
                    <i class="fa-solid fa-pen"></i>
                </button>

                {% if request.user.is_superuser or request.user.groups.all.0.name == "ADMIN" %}
                    <button type="button" 
                            class="btn btn-sm btn-outline-danger btn-delete-facture" 
                            data-id="{{ f.id }}" 
                            data-numero="{{ f.type_document }} N¬∞{{ f.id }}"
                            title="Supprimer">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                {% endif %}
            </div>
        </li>
    {% empty %}
        <li class="list-group-item text-center p-3 text-muted">
            Aucun document g√©n√©r√©.
        </li>
    {% endfor %}
</ul>





            </div>

             <div class="d-grid mt-4">
                <button class="btn btn-primary btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#factureModal">
                    <i class="fa-solid fa-file-invoice-dollar me-1"></i> G√âN√âRER FACTURE / DEVIS
                </button>
                 </div>
        </div>

        <div class="col-lg-6 col-md-12">
            <div class="card mb-4 border-success shadow-sm">
                <div class="card-header bg-success text-white">
                    <i class="fa-solid fa-pen-to-square me-1"></i> Modifier la commande
                </div>
                <div class="card-body">
                    <form method="POST" class="row g-3">
                        {% csrf_token %}
                        
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="mb-0 small fw-bold"><i class="fas fa-user-circle me-2"></i>Informations Client & Commande</h6>
                            </div>
                            <div class="card-body bg-light">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Nom Complet</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-user text-primary"></i></span>
                                            <input type="text" name="nom_client" class="form-control border-start-0 ps-0" value="{{ commande.nom_client }}" placeholder="Nom du client">
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Num√©ro Client</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-phone-alt text-success"></i></span>
                                            <input type="text" name="numero_client" class="form-control border-start-0 ps-0" value="{{ commande.numero_client }}" placeholder="Ex: 07 00 00 00 00">
                                        </div>
                                    </div>

                                    <div class="col-md-7">
                                        <label class="form-label small fw-bold text-muted">Localisation / Adresse</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-map-marker-alt text-danger"></i></span>
                                            <input type="text" name="localisation_client" class="form-control border-start-0 ps-0" value="{{ commande.localisation_client }}" placeholder="Quartier, Rue, Porte...">
                                        </div>
                                    </div>

                                    <div class="col-md-5">
                                        <label class="form-label small fw-bold text-muted">Type de Service</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-concierge-bell text-warning"></i></span>
                                            <select name="type_commande" class="form-select border-start-0 ps-0 fw-bold">
                                                <option value="CITYPROP" {% if commande.type_commande == 'CITYPROP' %}selected{% endif %}>CITYPROP</option>
                                                <option value="CLIMATISEUR" {% if commande.type_commande == 'CLIMATISEUR' %}selected{% endif %}>CLIMATISEUR</option>
                                                <option value="TAPISPROP" {% if commande.type_commande == 'TAPISPROP' %}selected{% endif %}>TAPISPROP</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

        {% if commande.type_commande == 'CITYPROP' or commande.type_commande == 'CLIMATISEUR' %}
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-info text-white py-2">
                    <h6 class="mb-0 small fw-bold"><i class="fas fa-edit me-2"></i>Modification Intervention Clima</h6>
                </div>
                <div class="card-body bg-light">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold"><i class="fas fa-tag me-1 text-primary"></i>D√©signation des √©quipements</label>
                            <input type="text" name="designation" class="form-control form-control-sm border-primary-subtle" value="{{ cityclima.designation|default:'' }}" placeholder="ex: Split Salon, Cassette Bureau...">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small fw-bold"><i class="fas fa-money-bill-wave me-1 text-success"></i>Co√ªt (FCFA)</label>
                            <input type="number" name="cout_clim" class="form-control form-control-sm" value="{{ cityclima.cout|default:0 }}">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small fw-bold"><i class="fas fa-calendar-day me-1 text-danger"></i>Date intervention</label>
                            <input type="date" name="date_intervention" class="form-control form-control-sm" value="{{ cityclima.date_intervention|date:'Y-m-d' }}">
                        </div>

                        <div class="col-md-12">
                            <label class="form-label small fw-bold"><i class="fas fa-smile me-1 text-warning"></i>Niveau de Satisfaction</label>
                            <select name="satisfaction" class="form-select form-select-sm">
                                <option value="">-- Choisir --</option>
                                <option value="OK" {% if cityclima.satisfaction == 'OK' %}selected{% endif %}>‚úÖ OK (Termin√©)</option>
                                <option value="KO_RET" {% if cityclima.satisfaction == 'KO_RET' %}selected{% endif %}>üîÑ KO - Retouche n√©cessaire</option>
                                <option value="KO_REFUS" {% if cityclima.satisfaction == 'KO_REFUS' %}selected{% endif %}>‚ùå KO - Refus client</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

                                {% elif commande.type_commande == 'TAPISPROP' %}
                                <div class="card border-0 shadow-sm mt-3">
                                <div class="card-header bg-dark text-white py-2">
                                    <h6 class="mb-0 small fw-bold"><i class="fas fa-rug me-2"></i>Mise √† jour Suivi Tapis</h6>
                                </div>
                                <div class="card-body bg-light">
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-muted">Date Ramassage</label>
                                            <input type="date" name="date_ramassage" class="form-control form-control-sm border-primary" value="{{ tapis.date_ramassage|date:'Y-m-d' }}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-muted">Fin de Traitement</label>
                                            <input type="date" name="date_traitement" class="form-control form-control-sm border-danger" value="{{ tapis.date_traitement|date:'Y-m-d' }}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-primary">Pr√©vue Livraison</label>
                                            <input type="date" name="date_prevue_livraison" class="form-control form-control-sm border-primary bg-primary-subtle" value="{{ tapis.date_prevue_livraison|date:'Y-m-d' }}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-muted">Livraison R√©elle</label>
                                            <input type="date" name="date_livraison" class="form-control form-control-sm border-success" value="{{ tapis.date_livraison|date:'Y-m-d' }}">
                                        </div>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold">Nombre de Tapis</label>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text"><i class="fas fa-layer-group"></i></span>
                                                <input type="number" name="nombre_tapis" class="form-control" value="{{ tapis.nombre_tapis }}">
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold">Co√ªt Estim√©</label>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">FCFA</span>
                                                <input type="number" name="cout" class="form-control fw-bold text-success" value="{{ tapis.cout }}">
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-danger">Statut Actuel</label>
                                            <select name="statut" class="form-select form-select-sm border-danger fw-bold">
                                                {% for code, label in tapis.STATUT_CHOICES %}
                                                    <option value="{{ code }}" {% if tapis.statut == code %}selected{% endif %}>{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label small fw-bold italic"><i class="far fa-comment-alt me-1"></i>Observations / Commentaires</label>
                                            <textarea name="commentaire" class="form-control form-control-sm" rows="2" placeholder="Notez ici les particularit√©s (taches, √©tat sp√©cial...)">{{ tapis.commentaire }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                {% endif %}

                                <div class="col-12 mt-4 d-flex justify-content-between">
                                    <button type="submit" class="btn btn-success px-4">
                                        <i class="fa-solid fa-floppy-disk me-1"></i> Mettre √† jour
                                    </button>
                                    <a href="{% url 'liste_fiches' %}" class="btn btn-secondary px-4">Retour</a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="factureModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <form method="POST" action="{% url 'creer_facture' fiche_id=commande.id %}">
                        {% csrf_token %}
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="fa-solid fa-plus me-2"></i>Nouveau Document pour {{ commande.nom_client }}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3 mb-4">
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold">Type</label>
                                    <select name="type_document" class="form-select form-select-sm">
                                        <option value="DEVIS">DEVIS</option>
                                        <option value="FACTURE">FACTURE</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label small fw-bold">Objet</label>
                                    <input type="text" name="objet" class="form-control form-control-sm" placeholder="Ex: Nettoyage complet">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Lieu</label>
                                    <input type="text" name="lieu_emission" class="form-control form-control-sm" value="Abidjan">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Signature</label>
                                    <input type="text" name="signature" class="form-control form-control-sm" value="LA COMPTABILIT√â">
                                </div>
                            </div>

                            <h6 class="text-primary border-bottom pb-2"><i class="fa-solid fa-list me-2"></i>Lignes de Prestation</h6>
                            
                            <div id="lignesFacture" class="mt-3">
                                <div class="row g-2 ligne-facture align-items-center mb-2">
                                    <div class="col-4">
                                        <input type="text" name="designation[]" class="form-control form-control-sm" placeholder="D√©signation" required>
                                    </div>
                                    <div class="col-1">
                                        <input type="number" name="quantite[]" class="form-control form-control-sm text-end quantite-input" value="1" min="1">
                                    </div>
                                    <div class="col-2">
                                        <input type="number" name="prix_unitaire[]" class="form-control form-control-sm text-end prix-unitaire-input" placeholder="Prix Unit." required>
                                    </div>
                                    <div class="col-2">
                                        <input type="text" class="form-control form-control-sm text-end total-ligne-display" value="0" readonly>
                                    </div>
                                    <div class="col-2">
                                        <input type="text" name="note_prix[]" class="form-control form-control-sm" placeholder="Note (ex: HT)">
                                    </div>
                                    <div class="col-1 text-center">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-line"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-sm btn-outline-secondary" id="ajouterLigne">
                                <i class="fa-solid fa-plus me-1"></i> Ajouter une prestation
                            </button>

                            <div class="row mt-4 pt-3 border-top g-3">
                                <div class="col-md-4">
                                    <div class="p-3 bg-light rounded">
                                        <div class="d-flex justify-content-between">
                                            <span class="small fw-bold">Total Brut HT:</span>
                                            <span id="totalHTFacture" class="text-primary fw-bold">0 FCFA</span>
                                        </div>
                                        <div class="d-flex justify-content-between mt-2 text-danger">
                                            <span class="small fw-bold">R√©duction:</span>
                                            <span id="montantReductionDisplay" class="fw-bold">0 FCFA</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small fw-bold">Taux R√©duction (%)</label>
                                            <input type="number" id="tauxReductionInput" name="taux_reduction" class="form-control" step="0.001" min="0" max="100">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small fw-bold">Ou Montant Fixe</label>
                                            <input type="number" id="montantReductionInput" class="form-control form-control-sm" placeholder="Ex: 2000">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-success">NET √Ä PAYER (Arrondi 5 FCFA)</label>
                                    <div class="input-group">
                                        <input type="text" id="totalFinalFacture" class="form-control form-control-lg text-end fw-bold text-success" value="0" readonly>
                                        <span class="input-group-text bg-success text-white">FCFA</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success btn-lg px-5">G√©n√©rer le document</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="deleteFactureModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fa-solid fa-triangle-exclamation me-2"></i>Confirmer la suppression</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>√ätes-vous s√ªr de vouloir supprimer d√©finitivement le document <strong id="deleteFactureNum"></strong> ?</p>
                        <p class="text-danger small"><i class="fa-solid fa-info-circle me-1"></i> Cette action est irr√©versible.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <form id="formSupprimerFacture" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Supprimer le document</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // === ELEMENTS EXISTANTS ===
        const formFacture = document.getElementById('formModifierFacture') || document.querySelector('form');
        const lignesFactureContainer = document.getElementById('lignesFacture');
        const ajouterLigneBtn = document.getElementById('ajouterLigne');
        const totalHTFacture = document.getElementById('totalHTFacture');
        const montantReductionDisplay = document.getElementById('montantReductionDisplay');
        const tauxReductionInput = document.getElementById('tauxReductionInput');
        const montantReductionInput = document.getElementById('montantReductionInput');
        const totalFinalFacture = document.getElementById('totalFinalFacture');

        // === ELEMENTS MODALS ===
        const deleteFactureModalElement = document.getElementById('deleteFactureModal');
        const deleteFactureModal = deleteFactureModalElement ? new bootstrap.Modal(deleteFactureModalElement) : null;
        const formSupprimerFacture = document.getElementById('formSupprimerFacture');

        // --- FONCTIONS DE FORMATAGE ET CALCUL ---

        const formatNumber = (num) => {
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "\u00A0");
        };

        const parseLocaleNumber = (string) => {
            if (!string) return 0;
            // Supprime les espaces, les ins√©cables et l'unit√© FCFA pour extraire le nombre
            return parseFloat(string.toString().replace(/\s/g, '').replace(/\u00A0/g, '').replace('FCFA', '')) || 0;
        };

        const calculateLineTotal = (lineElement) => {
            const quantite = parseFloat(lineElement.querySelector('.quantite-input').value) || 0;
            const prixUnitaire = parseFloat(lineElement.querySelector('.prix-unitaire-input').value) || 0;
            const total = quantite * prixUnitaire;
            lineElement.querySelector('.total-ligne-display').value = formatNumber(total); 
            return total;
        };

        const updateGeneralTotals = () => {
            let generalTotal = 0;
            document.querySelectorAll('.ligne-facture').forEach(lineElement => {
                generalTotal += calculateLineTotal(lineElement);
            });
            totalHTFacture.textContent = formatNumber(generalTotal) + " FCFA";
            updateFinalTotal(); 
            return generalTotal;
        };

        const updateFinalTotal = () => {
            const totalBase = parseLocaleNumber(totalHTFacture.textContent);
            let reduction = parseFloat(montantReductionInput.value) || 0;

            // --- APPLICATION DE L'ARRONDI √Ä 5 FCFA ---
            let valeur = Math.round(reduction);
            let dernierChiffre = valeur % 10;
            let base = Math.floor(valeur / 10) * 10;
            
            if (dernierChiffre < 3) { 
                reduction = base;
            } else if (dernierChiffre < 8) { 
                reduction = base + 5;
            } else { 
                reduction = base + 10;
            }

            const totalFinal = totalBase - reduction;
            
            montantReductionDisplay.textContent = "-" + formatNumber(reduction) + " FCFA";
            totalFinalFacture.value = formatNumber(totalFinal) + " FCFA";
        };

        // --- GESTION DES LIGNES ---

        const setupInputListeners = (lineElement) => {
            const inputs = lineElement.querySelectorAll('.quantite-input, .prix-unitaire-input');
            const removeBtn = lineElement.querySelector('.remove-line');

            removeBtn.addEventListener('click', function() {
                if (document.querySelectorAll('.ligne-facture').length > 1) {
                    lineElement.remove();
                    updateGeneralTotals(); 
                } else {
                    alert("Une facture doit comporter au moins une ligne.");
                }
            });
            
            inputs.forEach(input => {
                input.addEventListener('input', () => updateGeneralTotals());
            });
        };

        if(ajouterLigneBtn){
            ajouterLigneBtn.addEventListener('click', function(){
                const newLigneHTML = `
                    <div class="row g-2 ligne-facture align-items-center mb-2">
                        <div class="col-4"><input type="text" name="designation[]" class="form-control form-control-sm" placeholder="D√©signation" required></div>
                        <div class="col-1"><input type="number" name="quantite[]" class="form-control form-control-sm text-end quantite-input" value="1" min="1"></div>
                        <div class="col-2"><input type="number" name="prix_unitaire[]" class="form-control form-control-sm text-end prix-unitaire-input" min="0" required></div>
                        <div class="col-2"><input type="text" class="form-control form-control-sm text-end total-ligne-display" value="0" readonly></div>
                        <div class="col-2"><input type="text" name="note_prix[]" class="form-control form-control-sm" placeholder="Note"></div>
                        <div class="col-1 text-center"><button type="button" class="btn btn-outline-danger btn-sm remove-line"><i class="fa-solid fa-trash"></i></button></div>
                    </div>`;
                lignesFactureContainer.insertAdjacentHTML('beforeend', newLigneHTML);
                setupInputListeners(lignesFactureContainer.lastElementChild);
                updateGeneralTotals();
            });
        }

        // --- LOGIQUE R√âDUCTION ---

        tauxReductionInput.addEventListener('input', function() {
            let taux = parseFloat(this.value) || 0;
            if (taux < 0) taux = 0;
            if (taux > 100) taux = 100;

            const totalBase = parseLocaleNumber(totalHTFacture.textContent);
            const reductionMontant = (totalBase * taux) / 100;
            
            montantReductionInput.value = Math.round(reductionMontant);
            updateFinalTotal();
        });

        montantReductionInput.addEventListener('input', function() {
            const reductionMontant = parseFloat(this.value) || 0;
            const totalBase = parseLocaleNumber(totalHTFacture.textContent);
            
            if (totalBase > 0) {
                let taux = (reductionMontant / totalBase) * 100;
                tauxReductionInput.value = taux.toFixed(3);
            } else {
                tauxReductionInput.value = 0;
            }
            updateFinalTotal();
        });

        // --- NETTOYAGE AVANT ENVOI (SUBMIT) ---
        if (formFacture) {
            formFacture.addEventListener('submit', function() {
                // On transforme "215 000 FCFA" en "215000" pour Django
                totalFinalFacture.value = parseLocaleNumber(totalFinalFacture.value);
                
                // On nettoie aussi les totaux de chaque ligne
                document.querySelectorAll('.total-ligne-display').forEach(input => {
                    input.value = parseLocaleNumber(input.value);
                });
            });
        }

        // --- ACTIONS MODALS ---

        document.querySelectorAll('.btn-delete-facture').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const numero = this.dataset.numero;
                if (document.getElementById('deleteFactureNum')) {
                    document.getElementById('deleteFactureNum').textContent = numero;
                    formSupprimerFacture.action = `/facture/supprimer/${id}/`;
                    deleteFactureModal.show();
                }
            });
        });

        document.querySelectorAll('.btn-edit-facture').forEach(btn => {
            btn.addEventListener('click', function() {
                window.location.href = `/facture/modifier/${this.dataset.id}/`;
            });
        });

        // Initialisation
        document.querySelectorAll('.ligne-facture').forEach(setupInputListeners);
        updateGeneralTotals(); 
    });
</script>


{% endblock %}